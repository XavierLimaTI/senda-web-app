// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ============================================
// USUÁRIOS E AUTENTICAÇÃO
// ============================================

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  name      String
  role      String   @default("CLIENT") // CLIENT, THERAPIST, SPACE, ADMIN
  phone     String?
  avatar    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  emailVerified DateTime?
  
  // LGPD Compliance (Legal acceptance)
  acceptedTermsAt      DateTime? // Timestamp do aceite dos termos
  acceptedTermsVersion String?   @default("1.0.0") // Versão aceita
  marketingConsent     Boolean   @default(false)   // Opt-in para emails marketing
  dataProcessingConsent Boolean  @default(true)    // Necessário para usar plataforma

  // Relações
  clientProfile    ClientProfile?
  therapistProfile TherapistProfile?
  spaceProfile     SpaceProfile?
  bookings         Booking[]       @relation("ClientBookings")
  payments         Payment[]
  newsArticles     NewsArticle[]
  subscriptions    Subscription[]
  emailVerificationTokens EmailVerificationToken[]
}

// ============================================
// PERFIS ESPECIALIZADOS
// ============================================

model ClientProfile {
  id          Int      @id @default(autoincrement())
  userId      Int      @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  preferences String?  // JSON: intenções, preferências
  phone       String?
  createdAt   DateTime @default(now())
  
  trailProgress TrailProgress[]
  favorites     TherapistFavorite[]
}

model TherapistProfile {
  id           Int      @id @default(autoincrement())
  userId       Int      @unique
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  bio          String?
  specialty    String   // Ex: "Reiki, Acupuntura"
  license      String?  // CRP, certificados
  experience   Int?     // Anos de experiência
  rating       Float    @default(0)
  verified     Boolean  @default(false)
  phone        String?
  createdAt    DateTime @default(now())
  
  services     Service[]
  availability Availability[]
  bookings     Booking[]       @relation("TherapistBookings")
  trails       Trail[]
  reviews      Review[]        @relation("TherapistReviews")
  favoritedBy  TherapistFavorite[]
}

model SpaceProfile {
  id          Int      @id @default(autoincrement())
  userId      Int      @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String
  description String?
  address     String
  cnpj        String?
  phone       String?
  amenities   String?  // JSON: comodidades
  verified    Boolean  @default(false)
  createdAt   DateTime @default(now())
  
  rooms       Room[]
  packages    Package[]
}

// ============================================
// SERVIÇOS E DISPONIBILIDADE
// ============================================

model Service {
  id           Int      @id @default(autoincrement())
  name         String
  description  String?
  duration     Int      // Minutos
  price        Float
  therapistId  Int
  therapist    TherapistProfile @relation(fields: [therapistId], references: [id], onDelete: Cascade)
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  
  bookings     Booking[]
}

model Availability {
  id          Int      @id @default(autoincrement())
  therapistId Int
  therapist   TherapistProfile @relation(fields: [therapistId], references: [id], onDelete: Cascade)
  dayOfWeek   Int      // 0-6 (Dom-Sáb)
  startTime   String   // "09:00"
  endTime     String   // "18:00"
}

// ============================================
// ESPAÇOS: SALAS E PACOTES
// ============================================

model Room {
  id          Int      @id @default(autoincrement())
  spaceId     Int
  space       SpaceProfile @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  name        String
  type        String   // "Sala de Massagem", "Studio Yoga"
  pricePerHour Float
  amenities   String?  // JSON
  active      Boolean  @default(true)
  
  roomBookings RoomBooking[]
}

model Package {
  id          Int      @id @default(autoincrement())
  spaceId     Int
  space       SpaceProfile @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  name        String
  description String?
  duration    Int      // Minutos
  price       Float
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
}

// ============================================
// AGENDAMENTOS
// ============================================

model Booking {
  id          Int      @id @default(autoincrement())
  clientId    Int
  client      User     @relation("ClientBookings", fields: [clientId], references: [id], onDelete: Cascade)
  therapistId Int
  therapist   TherapistProfile @relation("TherapistBookings", fields: [therapistId], references: [id])
  serviceId   Int
  service     Service  @relation(fields: [serviceId], references: [id])
  startTime   DateTime
  endTime     DateTime
  status      String   @default("PENDING") // PENDING, CONFIRMED, COMPLETED, CANCELLED
  notes       String?
  createdAt   DateTime @default(now())
  
  payment     Payment?
  review      Review?
}

model RoomBooking {
  id          Int      @id @default(autoincrement())
  roomId      Int
  room        Room     @relation(fields: [roomId], references: [id])
  therapistId Int      // Terapeuta que alugou
  startTime   DateTime
  endTime     DateTime
  status      String   @default("CONFIRMED")
  price       Float
  createdAt   DateTime @default(now())
}

// ============================================
// PAGAMENTOS
// ============================================

model Payment {
  id              Int      @id @default(autoincrement())
  bookingId       Int      @unique
  booking         Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  subscriptionId  Int?
  subscription    Subscription? @relation(fields: [subscriptionId], references: [id])
  userId          Int
  user            User     @relation(fields: [userId], references: [id])
  amount          Float
  sendaFee        Float    // Taxa do Senda
  professionalAmount Float // Valor líquido do profissional
  status          String   @default("PENDING") // PENDING, APPROVED, FAILED, REFUNDED
  method          String   // "credit_card", "pix"
  transactionId   String?
  createdAt       DateTime @default(now())
  
  @@index([userId])
  @@index([status])
}

// ============================================
// TRILHAS DE CUIDADO
// ============================================

model Trail {
  id          Int      @id @default(autoincrement())
  title       String
  description String
  coverImage  String?
  category    String   // "Mindfulness", "Yoga"
  duration    Int      // Dias
  authorId    Int?
  author      TherapistProfile? @relation(fields: [authorId], references: [id])
  published   Boolean  @default(false)
  createdAt   DateTime @default(now())
  
  lessons     Lesson[]
  progress    TrailProgress[]
}

model Lesson {
  id          Int     @id @default(autoincrement())
  trailId     Int
  trail       Trail   @relation(fields: [trailId], references: [id], onDelete: Cascade)
  title       String
  content     String  // Markdown ou HTML
  contentType String  // "text", "audio", "video"
  mediaUrl    String?
  order       Int
}

model TrailProgress {
  id               Int      @id @default(autoincrement())
  clientId         Int
  client           ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)
  trailId          Int
  trail            Trail    @relation(fields: [trailId], references: [id])
  completedLessons Int      @default(0)
  status           String   @default("IN_PROGRESS") // IN_PROGRESS, COMPLETED
  startedAt        DateTime @default(now())
  completedAt      DateTime?
}

// Tokens de verificação de e-mail
model EmailVerificationToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
}

// ============================================
// AVALIAÇÕES (REVIEWS)
// ============================================

model Review {
  id          Int      @id @default(autoincrement())
  bookingId   Int      @unique
  booking     Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  therapistId Int
  therapist   TherapistProfile @relation("TherapistReviews", fields: [therapistId], references: [id])
  clientId    Int
  rating      Int      // 1-5 estrelas
  comment     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([therapistId])
  @@index([createdAt])
}

// ============================================
// FAVORITOS
// ============================================

model TherapistFavorite {
  id          Int      @id @default(autoincrement())
  clientId    Int
  client      ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)
  therapistId Int
  therapist   TherapistProfile @relation(fields: [therapistId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())

  @@unique([clientId, therapistId])
  @@index([clientId])
  @@index([therapistId])
}

// ============================================
// NOTIFICAÇÕES
// ============================================

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int
  type      String   // "FAVORITE_AVAILABILITY", "BOOKING_REMINDER", "REVIEW_REQUEST"
  title     String
  message   String
  data      String?  // JSON com dados extras (therapistId, bookingId, etc)
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  
  @@index([userId, read])
  @@index([createdAt])
}

// ============================================
// NOTÍCIAS & BLOG
// ============================================

model NewsArticle {
  id          Int      @id @default(autoincrement())
  title       String
  slug        String   @unique
  description String
  content     String   // Markdown ou HTML
  thumbnail   String?  // URL da imagem
  published   Boolean  @default(false)
  featured    Boolean  @default(false)
  authorId    Int      // Admin/editor user id
  author      User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  views       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  publishedAt DateTime?
  
  @@index([published])
  @@index([featured])
  @@index([publishedAt])
  @@index([authorId])
}

// ============================================
// ASSINATURAS & PLANOS
// ============================================

model SubscriptionPlan {
  id          Int      @id @default(autoincrement())
  name        String   // FREE, PRO, PREMIUM
  role        String   // CLIENT, THERAPIST, SPACE (que tipo de usuário)
  monthlyFee  Float    @default(0) // R$ 0, R$ 29, R$ 79
  perSession  Float    @default(0) // Taxa por sessão (se houver)
  features    String   // JSON array de strings ["Feature 1", "Feature 2"]
  description String?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relações
  subscriptions Subscription[]
  
  @@index([role])
  @@index([active])
  @@unique([role, name])
}

model Subscription {
  id              Int      @id @default(autoincrement())
  userId          Int
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  planId          Int
  status          String   @default("ACTIVE") // ACTIVE, PAUSED, CANCELLED, EXPIRED
  currentPeriodStart DateTime
  currentPeriodEnd DateTime
  cancelledAt     DateTime?
  cancelReason    String?
  autoRenew       Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relações
  plan            SubscriptionPlan @relation(fields: [planId], references: [id])
  payments        Payment[]
  
  @@index([userId])
  @@index([status])
  @@index([planId])
  @@index([currentPeriodEnd])
}

// Adicionar campo subscription ao model Payment
// payment: {
//   subscriptionId  Int?
//   subscription    Subscription? @relation(fields: [subscriptionId], references: [id])
// }

